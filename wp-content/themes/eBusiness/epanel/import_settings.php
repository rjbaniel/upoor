<?php
add_action( 'admin_enqueue_scripts', 'import_epanel_javascript' );
function import_epanel_javascript( $hook_suffix ) {
	if ( 'admin.php' == $hook_suffix && isset( $_GET['import'] ) && isset( $_GET['step'] ) && 'wordpress' == $_GET['import'] && '1' == $_GET['step'] )
		add_action( 'admin_head', 'admin_headhook' );
}

function admin_headhook(){ ?>
	<script type="text/javascript">
		jQuery(document).ready(function($){
			$("p.submit").before("<p><input type='checkbox' id='importepanel' name='importepanel' value='1' style='margin-right: 5px;'><label for='importepanel'>Replace ePanel settings with sample data values</label></p>");
		});
	</script>
<?php }

add_action('import_end','importend');
function importend(){
	global $wpdb, $shortname;

	#make custom fields image paths point to sampledata/sample_images folder
	$sample_images_postmeta = $wpdb->get_results(
		$wpdb->prepare( "SELECT meta_id, meta_value FROM $wpdb->postmeta WHERE meta_value REGEXP %s", 'http://et_sample_images.com' )
	);
	if ( $sample_images_postmeta ) {
		foreach ( $sample_images_postmeta as $postmeta ){
			$template_dir = get_template_directory_uri();
			if ( is_multisite() ){
				switch_to_blog(1);
				$main_siteurl = site_url();
				restore_current_blog();

				$template_dir = $main_siteurl . '/wp-content/themes/' . get_template();
			}
			preg_match( '/http:\/\/et_sample_images.com\/([^.]+).jpg/', $postmeta->meta_value, $matches );
			$image_path = $matches[1];

			$local_image = preg_replace( '/http:\/\/et_sample_images.com\/([^.]+).jpg/', $template_dir . '/sampledata/sample_images/$1.jpg', $postmeta->meta_value );

			$local_image = preg_replace( '/s:55:/', 's:' . strlen( $template_dir . '/sampledata/sample_images/' . $image_path . '.jpg' ) . ':', $local_image );

			$wpdb->update( $wpdb->postmeta, array( 'meta_value' => esc_url_raw( $local_image ) ), array( 'meta_id' => $postmeta->meta_id ), array( '%s' ) );
		}
	}

	if ( !isset($_POST['importepanel']) )
		return;

	$importOptions = 'YToxMjY6e3M6MDoiIjtOO3M6MTQ6ImVidXNpbmVzc19sb2dvIjtzOjA6IiI7czoxNzoiZWJ1c2luZXNzX2Zhdmljb24iO3M6MDoiIjtzOjIyOiJlYnVzaW5lc3NfY29sb3Jfc2NoZW1lIjtzOjc6IkRlZmF1bHQiO3M6MjA6ImVidXNpbmVzc19ibG9nX3N0eWxlIjtOO3M6MTY6ImVidXNpbmVzc19mb290ZXIiO3M6Mjoib24iO3M6MjA6ImVidXNpbmVzc19ncmFiX2ltYWdlIjtOO3M6MjE6ImVidXNpbmVzc19kYXRlX2Zvcm1hdCI7czo3OiJNIGpTLCBZIjtzOjIyOiJlYnVzaW5lc3NfY2F0bnVtX3Bvc3RzIjtzOjE6IjUiO3M6MjY6ImVidXNpbmVzc19hcmNoaXZlbnVtX3Bvc3RzIjtzOjE6IjUiO3M6MjU6ImVidXNpbmVzc19zZWFyY2hudW1fcG9zdHMiO3M6MToiNSI7czoyMjoiZWJ1c2luZXNzX3RhZ251bV9wb3N0cyI7czoxOiI1IjtzOjIxOiJlYnVzaW5lc3NfdXNlX2V4Y2VycHQiO047czoyNjoiZWJ1c2luZXNzX2hvbWVfcGFnZV9udW1iZXIiO3M6MToiMiI7czoyMToiZWJ1c2luZXNzX2hvbWVfcGFnZV8xIjtzOjU6IkFib3V0IjtzOjIxOiJlYnVzaW5lc3NfaG9tZV9wYWdlXzIiO3M6OToiV2hhdCBJIERvIjtzOjIxOiJlYnVzaW5lc3NfaG9tZV9wYWdlXzMiO3M6NToiQWJvdXQiO3M6MjE6ImVidXNpbmVzc19ob21lX3BhZ2VfNCI7czo1OiJBYm91dCI7czoyNToiZWJ1c2luZXNzX3Njcm9sbGVyX251bWJlciI7czoxOiIzIjtzOjE5OiJlYnVzaW5lc3NfaG9tZV9ibG9nIjtzOjI6Im9uIjtzOjI0OiJlYnVzaW5lc3NfZXhsY2F0c19yZWNlbnQiO047czoyNDoiZWJ1c2luZXNzX2hvbWVwYWdlX3Bvc3RzIjtzOjE6IjYiO3M6MTM6ImVidXNpbmVzc19yc3MiO3M6MToiIyI7czoyOToiZWJ1c2luZXNzX2Jsb2dzdHlsZV9ob21lcG9zdHMiO3M6MToiNiI7czoyMzoiZWJ1c2luZXNzX3NsaWRlcl8xX3R5cGUiO3M6NToiSW1hZ2UiO3M6MjU6ImVidXNpbmVzc19zbGlkZXJfMV9idXR0b24iO3M6NzoiVGl0bGUgMSI7czoyNDoiZWJ1c2luZXNzX3NsaWRlcl8xX3RpdGxlIjtzOjI0OiJOZXF1ZSBwb3JybyBxdWlzcXVhbSBlc3QiO3M6MjQ6ImVidXNpbmVzc19zbGlkZXJfMV9pbWFnZSI7czo2NToiaHR0cDovL2Zhcm01LnN0YXRpYy5mbGlja3IuY29tLzQxMDQvNTA0MDMxMjI1NV9hZjM2YjdlYjg3X3pfZC5qcGciO3M6MjQ6ImVidXNpbmVzc19zbGlkZXJfMV92aWRlbyI7czowOiIiO3M6MjY6ImVidXNpbmVzc19zbGlkZXJfMV9jb250ZW50IjtzOjM3MDoiU2VkIHV0IHBlcnNwaWNpYXRpcyB1bmRlIG9tbmlzIGlzdGUgbmF0dXMgZXJyb3Igc2l0IHZvbHVwdGF0ZW0gYWNjdXNhbnRpdW0gZG9sb3JlbXF1ZSBsYXVkYW50aXVtLCB0b3RhbSByZW0gYXBlcmlhbSwgZWFxdWUgaXBzYSBxdWFlIGFiIGlsbG8gaW52ZW50b3JlIHZlcml0YXRpcyBldCBxdWFzaSBhcmNoaXRlY3RvIGJlYXRhZSB2aXRhZSBkaWN0YSBzdW50IGV4cGxpY2Fiby4gTmVtbyBlbmltIGlwc2FtIHZvbHVwdGF0ZW0gcXVpYSB2b2x1cHRhcyBzaXQgYXNwZXJuYXR1ciBhdXQgb2RpdCBhdXQgZnVnaXQsIHNlZCBxdWlhIGNvbnNlcXV1bnR1ciBtYWduaSBkb2xvcmVzIGVvcyBxdWkgcmF0aW9uZSB2b2x1cHRhdGVtIHNlcXVpIG5lc2NpdW50LiI7czoyNzoiZWJ1c2luZXNzX3NsaWRlcl8xX3JlYWRtb3JlIjtzOjI6Im9uIjtzOjMxOiJlYnVzaW5lc3Nfc2xpZGVyXzFfcmVhZG1vcmVfdXJsIjtzOjE6IiMiO3M6MjM6ImVidXNpbmVzc19zbGlkZXJfMl90eXBlIjtzOjU6IkltYWdlIjtzOjI1OiJlYnVzaW5lc3Nfc2xpZGVyXzJfYnV0dG9uIjtzOjc6IlRpdGxlIDIiO3M6MjQ6ImVidXNpbmVzc19zbGlkZXJfMl90aXRsZSI7czoyNDoiTmVxdWUgcG9ycm8gcXVpc3F1YW0gZXN0IjtzOjI0OiJlYnVzaW5lc3Nfc2xpZGVyXzJfaW1hZ2UiO3M6NjM6Imh0dHA6Ly9mYXJtNS5zdGF0aWMuZmxpY2tyLmNvbS80MTA5LzUwNDA5MzM5NjJfODUwOTBmZWYzMF96LmpwZyI7czoyNDoiZWJ1c2luZXNzX3NsaWRlcl8yX3ZpZGVvIjtzOjA6IiI7czoyNjoiZWJ1c2luZXNzX3NsaWRlcl8yX2NvbnRlbnQiO3M6MzcwOiJTZWQgdXQgcGVyc3BpY2lhdGlzIHVuZGUgb21uaXMgaXN0ZSBuYXR1cyBlcnJvciBzaXQgdm9sdXB0YXRlbSBhY2N1c2FudGl1bSBkb2xvcmVtcXVlIGxhdWRhbnRpdW0sIHRvdGFtIHJlbSBhcGVyaWFtLCBlYXF1ZSBpcHNhIHF1YWUgYWIgaWxsbyBpbnZlbnRvcmUgdmVyaXRhdGlzIGV0IHF1YXNpIGFyY2hpdGVjdG8gYmVhdGFlIHZpdGFlIGRpY3RhIHN1bnQgZXhwbGljYWJvLiBOZW1vIGVuaW0gaXBzYW0gdm9sdXB0YXRlbSBxdWlhIHZvbHVwdGFzIHNpdCBhc3Blcm5hdHVyIGF1dCBvZGl0IGF1dCBmdWdpdCwgc2VkIHF1aWEgY29uc2VxdXVudHVyIG1hZ25pIGRvbG9yZXMgZW9zIHF1aSByYXRpb25lIHZvbHVwdGF0ZW0gc2VxdWkgbmVzY2l1bnQuIjtzOjI3OiJlYnVzaW5lc3Nfc2xpZGVyXzJfcmVhZG1vcmUiO3M6Mjoib24iO3M6MzE6ImVidXNpbmVzc19zbGlkZXJfMl9yZWFkbW9yZV91cmwiO3M6MToiIyI7czoyMzoiZWJ1c2luZXNzX3NsaWRlcl8zX3R5cGUiO3M6NToiSW1hZ2UiO3M6MjU6ImVidXNpbmVzc19zbGlkZXJfM19idXR0b24iO3M6NzoiVGl0bGUgMyI7czoyNDoiZWJ1c2luZXNzX3NsaWRlcl8zX3RpdGxlIjtzOjI0OiJOZXF1ZSBwb3JybyBxdWlzcXVhbSBlc3QiO3M6MjQ6ImVidXNpbmVzc19zbGlkZXJfM19pbWFnZSI7czo2MzoiaHR0cDovL2Zhcm01LnN0YXRpYy5mbGlja3IuY29tLzQwOTAvNTA0MDkzMzgxMF8zNjU1MTA0ZDZmX3ouanBnIjtzOjI0OiJlYnVzaW5lc3Nfc2xpZGVyXzNfdmlkZW8iO3M6MDoiIjtzOjI2OiJlYnVzaW5lc3Nfc2xpZGVyXzNfY29udGVudCI7czozNzA6IlNlZCB1dCBwZXJzcGljaWF0aXMgdW5kZSBvbW5pcyBpc3RlIG5hdHVzIGVycm9yIHNpdCB2b2x1cHRhdGVtIGFjY3VzYW50aXVtIGRvbG9yZW1xdWUgbGF1ZGFudGl1bSwgdG90YW0gcmVtIGFwZXJpYW0sIGVhcXVlIGlwc2EgcXVhZSBhYiBpbGxvIGludmVudG9yZSB2ZXJpdGF0aXMgZXQgcXVhc2kgYXJjaGl0ZWN0byBiZWF0YWUgdml0YWUgZGljdGEgc3VudCBleHBsaWNhYm8uIE5lbW8gZW5pbSBpcHNhbSB2b2x1cHRhdGVtIHF1aWEgdm9sdXB0YXMgc2l0IGFzcGVybmF0dXIgYXV0IG9kaXQgYXV0IGZ1Z2l0LCBzZWQgcXVpYSBjb25zZXF1dW50dXIgbWFnbmkgZG9sb3JlcyBlb3MgcXVpIHJhdGlvbmUgdm9sdXB0YXRlbSBzZXF1aSBuZXNjaXVudC4iO3M6Mjc6ImVidXNpbmVzc19zbGlkZXJfM19yZWFkbW9yZSI7czoyOiJvbiI7czozMToiZWJ1c2luZXNzX3NsaWRlcl8zX3JlYWRtb3JlX3VybCI7czoxOiIjIjtzOjE5OiJlYnVzaW5lc3NfbWVudXBhZ2VzIjtOO3M6MjY6ImVidXNpbmVzc19lbmFibGVfZHJvcGRvd25zIjtzOjI6Im9uIjtzOjE5OiJlYnVzaW5lc3NfaG9tZV9saW5rIjtzOjI6Im9uIjtzOjI3OiJlYnVzaW5lc3NfdGllcnNfc2hvd25fcGFnZXMiO3M6MToiMyI7czoyMDoiZWJ1c2luZXNzX3NvcnRfcGFnZXMiO3M6MTA6InBvc3RfdGl0bGUiO3M6MjA6ImVidXNpbmVzc19vcmRlcl9wYWdlIjtzOjM6ImFzYyI7czoyMDoiZWJ1c2luZXNzX2NhdGVnb3JpZXMiO3M6Mjoib24iO3M6MTk6ImVidXNpbmVzc19ibG9nX2xpbmsiO3M6Mjoib24iO3M6MTg6ImVidXNpbmVzc19ibG9nX2NhdCI7czo0OiJCbG9nIjtzOjE4OiJlYnVzaW5lc3NfbWVudWNhdHMiO047czozNzoiZWJ1c2luZXNzX2VuYWJsZV9kcm9wZG93bnNfY2F0ZWdvcmllcyI7czoyOiJvbiI7czozMjoiZWJ1c2luZXNzX3RpZXJzX3Nob3duX2NhdGVnb3JpZXMiO3M6MToiMyI7czoxODoiZWJ1c2luZXNzX3NvcnRfY2F0IjtzOjQ6Im5hbWUiO3M6MTk6ImVidXNpbmVzc19vcmRlcl9jYXQiO3M6MzoiYXNjIjtzOjI1OiJlYnVzaW5lc3NfZGlzYWJsZV90b3B0aWVyIjtOO3M6MTk6ImVidXNpbmVzc19wb3N0aW5mbzEiO2E6Mzp7aTowO3M6NjoiYXV0aG9yIjtpOjE7czo0OiJkYXRlIjtpOjI7czo4OiJjb21tZW50cyI7fXM6Mjc6ImVidXNpbmVzc19zaG93X3Bvc3Rjb21tZW50cyI7czoyOiJvbiI7czoyMDoiZWJ1c2luZXNzX3RodW1ibmFpbHMiO3M6Mjoib24iO3M6MjQ6ImVidXNpbmVzc190aHVtYm5haWxfc2l6ZSI7czozOiIyMDAiO3M6MjU6ImVidXNpbmVzc19wYWdlX3RodW1ibmFpbHMiO047czoyODoiZWJ1c2luZXNzX3Nob3dfcGFnZXNjb21tZW50cyI7TjtzOjMxOiJlYnVzaW5lc3NfdGh1bWJuYWlsX3dpZHRoX3BhZ2VzIjtzOjM6IjIwMCI7czozMjoiZWJ1c2luZXNzX3RodW1ibmFpbF9oZWlnaHRfcGFnZXMiO3M6MzoiMjAwIjtzOjE3OiJlYnVzaW5lc3NfZXhjZXJwdCI7TjtzOjE5OiJlYnVzaW5lc3NfZnVsbF9wb3N0IjtOO3M6MjY6ImVidXNpbmVzc190aHVtYm5haWxzX2luZGV4IjtzOjI6Im9uIjtzOjIzOiJlYnVzaW5lc3NfcmVhZG1vcmVfbGluayI7czoyOiJvbiI7czozMDoiZWJ1c2luZXNzX3RodW1ibmFpbF9zaXplX2luZGV4IjtzOjM6IjIwMCI7czoyMzoiZWJ1c2luZXNzX2NvbnRlbnRfbGltaXQiO3M6MzoiNDAwIjtzOjIzOiJlYnVzaW5lc3NfY3VzdG9tX2NvbG9ycyI7TjtzOjE5OiJlYnVzaW5lc3NfY2hpbGRfY3NzIjtOO3M6MjI6ImVidXNpbmVzc19jaGlsZF9jc3N1cmwiO3M6MDoiIjtzOjIzOiJlYnVzaW5lc3NfY29sb3JfYmdjb2xvciI7czowOiIiO3M6MjQ6ImVidXNpbmVzc19jb2xvcl9tYWluZm9udCI7czowOiIiO3M6MjQ6ImVidXNpbmVzc19jb2xvcl9tYWlubGluayI7czowOiIiO3M6MjQ6ImVidXNpbmVzc19jb2xvcl9wYWdlbGluayI7czowOiIiO3M6MjQ6ImVidXNpbmVzc19jb2xvcl9jYXRzbGluayI7czowOiIiO3M6MjQ6ImVidXNpbmVzc19jb2xvcl9wb3N0aW5mbyI7czowOiIiO3M6MjY6ImVidXNpbmVzc19jb2xvcl9mZWF0aGVhZGVyIjtzOjA6IiI7czoyNDoiZWJ1c2luZXNzX2NvbG9yX2ZlYXR0ZXh0IjtzOjA6IiI7czozMjoiZWJ1c2luZXNzX2NvbG9yX3NpZGViYXJiZ190aXRsZXMiO3M6MDoiIjtzOjMwOiJlYnVzaW5lc3NfY29sb3Jfc2lkZWJhcl90aXRsZXMiO3M6MDoiIjtzOjI5OiJlYnVzaW5lc3NfY29sb3JfZm9vdGVyX3RpdGxlcyI7czowOiIiO3M6Mjg6ImVidXNpbmVzc19jb2xvcl9mb290ZXJfbGlua3MiO3M6MDoiIjtzOjIzOiJlYnVzaW5lc3NfY29sb3JfaGVhZGluZyI7czowOiIiO3M6MjQ6ImVidXNpbmVzc19zZW9faG9tZV90aXRsZSI7TjtzOjMwOiJlYnVzaW5lc3Nfc2VvX2hvbWVfZGVzY3JpcHRpb24iO047czoyNzoiZWJ1c2luZXNzX3Nlb19ob21lX2tleXdvcmRzIjtOO3M6Mjg6ImVidXNpbmVzc19zZW9faG9tZV9jYW5vbmljYWwiO047czoyODoiZWJ1c2luZXNzX3Nlb19ob21lX3RpdGxldGV4dCI7czowOiIiO3M6MzQ6ImVidXNpbmVzc19zZW9faG9tZV9kZXNjcmlwdGlvbnRleHQiO3M6MDoiIjtzOjMxOiJlYnVzaW5lc3Nfc2VvX2hvbWVfa2V5d29yZHN0ZXh0IjtzOjA6IiI7czoyMzoiZWJ1c2luZXNzX3Nlb19ob21lX3R5cGUiO3M6Mjc6IkJsb2dOYW1lIHwgQmxvZyBkZXNjcmlwdGlvbiI7czoyNzoiZWJ1c2luZXNzX3Nlb19ob21lX3NlcGFyYXRlIjtzOjM6IiB8ICI7czoyNjoiZWJ1c2luZXNzX3Nlb19zaW5nbGVfdGl0bGUiO047czozMjoiZWJ1c2luZXNzX3Nlb19zaW5nbGVfZGVzY3JpcHRpb24iO047czoyOToiZWJ1c2luZXNzX3Nlb19zaW5nbGVfa2V5d29yZHMiO047czozMDoiZWJ1c2luZXNzX3Nlb19zaW5nbGVfY2Fub25pY2FsIjtOO3M6MzI6ImVidXNpbmVzc19zZW9fc2luZ2xlX2ZpZWxkX3RpdGxlIjtzOjk6InNlb190aXRsZSI7czozODoiZWJ1c2luZXNzX3Nlb19zaW5nbGVfZmllbGRfZGVzY3JpcHRpb24iO3M6MTU6InNlb19kZXNjcmlwdGlvbiI7czozNToiZWJ1c2luZXNzX3Nlb19zaW5nbGVfZmllbGRfa2V5d29yZHMiO3M6MTI6InNlb19rZXl3b3JkcyI7czoyNToiZWJ1c2luZXNzX3Nlb19zaW5nbGVfdHlwZSI7czoyMToiUG9zdCB0aXRsZSB8IEJsb2dOYW1lIjtzOjI5OiJlYnVzaW5lc3Nfc2VvX3NpbmdsZV9zZXBhcmF0ZSI7czozOiIgfCAiO3M6Mjk6ImVidXNpbmVzc19zZW9faW5kZXhfY2Fub25pY2FsIjtOO3M6MzE6ImVidXNpbmVzc19zZW9faW5kZXhfZGVzY3JpcHRpb24iO047czoyNDoiZWJ1c2luZXNzX3Nlb19pbmRleF90eXBlIjtzOjI0OiJDYXRlZ29yeSBuYW1lIHwgQmxvZ05hbWUiO3M6Mjg6ImVidXNpbmVzc19zZW9faW5kZXhfc2VwYXJhdGUiO3M6MzoiIHwgIjtzOjMzOiJlYnVzaW5lc3NfaW50ZWdyYXRlX2hlYWRlcl9lbmFibGUiO3M6Mjoib24iO3M6MzE6ImVidXNpbmVzc19pbnRlZ3JhdGVfYm9keV9lbmFibGUiO3M6Mjoib24iO3M6MzY6ImVidXNpbmVzc19pbnRlZ3JhdGVfc2luZ2xldG9wX2VuYWJsZSI7czoyOiJvbiI7czozOToiZWJ1c2luZXNzX2ludGVncmF0ZV9zaW5nbGVib3R0b21fZW5hYmxlIjtzOjI6Im9uIjtzOjI2OiJlYnVzaW5lc3NfaW50ZWdyYXRpb25faGVhZCI7czowOiIiO3M6MjY6ImVidXNpbmVzc19pbnRlZ3JhdGlvbl9ib2R5IjtzOjA6IiI7czozMjoiZWJ1c2luZXNzX2ludGVncmF0aW9uX3NpbmdsZV90b3AiO3M6MDoiIjtzOjM1OiJlYnVzaW5lc3NfaW50ZWdyYXRpb25fc2luZ2xlX2JvdHRvbSI7czowOiIiO3M6MjI6ImVidXNpbmVzc19mb3Vyc2l4ZWlnaHQiO047czoyMDoiZWJ1c2luZXNzX2Jhbm5lcl80NjgiO3M6MDoiIjtzOjI0OiJlYnVzaW5lc3NfYmFubmVyXzQ2OF91cmwiO3M6MDoiIjt9';

	/*global $options;

	foreach ($options as $value) {
		if( isset( $value['id'] ) ) {
			update_option( $value['id'], $value['std'] );
		}
	}*/

	$importedOptions = unserialize(base64_decode($importOptions));

	foreach ($importedOptions as $key=>$value) {
		if ($value != '') update_option( $key, $value );
	}
} ?>