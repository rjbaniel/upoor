<?php
add_action( 'admin_enqueue_scripts', 'import_epanel_javascript' );
function import_epanel_javascript( $hook_suffix ) {
	if ( 'admin.php' == $hook_suffix && isset( $_GET['import'] ) && isset( $_GET['step'] ) && 'wordpress' == $_GET['import'] && '1' == $_GET['step'] )
		add_action( 'admin_head', 'admin_headhook' );
}

function admin_headhook(){ ?>
	<script type="text/javascript">
		jQuery(document).ready(function($){
			$("p.submit").before("<p><input type='checkbox' id='importepanel' name='importepanel' value='1' style='margin-right: 5px;'><label for='importepanel'>Replace ePanel settings with sample data values</label></p>");
		});
	</script>
<?php }

add_action('import_end','importend');
function importend(){
	global $wpdb, $shortname;

	#make custom fields image paths point to sampledata/sample_images folder
	$sample_images_postmeta = $wpdb->get_results(
		$wpdb->prepare( "SELECT meta_id, meta_value FROM $wpdb->postmeta WHERE meta_value REGEXP %s", 'http://et_sample_images.com' )
	);
	if ( $sample_images_postmeta ) {
		foreach ( $sample_images_postmeta as $postmeta ){
			$template_dir = get_template_directory_uri();
			if ( is_multisite() ){
				switch_to_blog(1);
				$main_siteurl = site_url();
				restore_current_blog();

				$template_dir = $main_siteurl . '/wp-content/themes/' . get_template();
			}
			preg_match( '/http:\/\/et_sample_images.com\/([^.]+).jpg/', $postmeta->meta_value, $matches );
			$image_path = $matches[1];

			$local_image = preg_replace( '/http:\/\/et_sample_images.com\/([^.]+).jpg/', $template_dir . '/sampledata/sample_images/$1.jpg', $postmeta->meta_value );

			$local_image = preg_replace( '/s:55:/', 's:' . strlen( $template_dir . '/sampledata/sample_images/' . $image_path . '.jpg' ) . ':', $local_image );

			$wpdb->update( $wpdb->postmeta, array( 'meta_value' => esc_url_raw( $local_image ) ), array( 'meta_id' => $postmeta->meta_id ), array( '%s' ) );
		}
	}

	if ( !isset($_POST['importepanel']) )
		return;

	$importOptions = 'YToxMDQ6e3M6MDoiIjtOO3M6MTk6InRoZWNvcnBvcmF0aW9uX2xvZ28iO3M6MDoiIjtzOjIyOiJ0aGVjb3Jwb3JhdGlvbl9mYXZpY29uIjtzOjA6IiI7czoyNzoidGhlY29ycG9yYXRpb25fY29sb3Jfc2NoZW1lIjtzOjQ6IkJsdWUiO3M6MjU6InRoZWNvcnBvcmF0aW9uX2Jsb2dfc3R5bGUiO047czoyNToidGhlY29ycG9yYXRpb25fZ3JhYl9pbWFnZSI7TjtzOjI3OiJ0aGVjb3Jwb3JhdGlvbl9jYXRudW1fcG9zdHMiO3M6MToiNiI7czozMToidGhlY29ycG9yYXRpb25fYXJjaGl2ZW51bV9wb3N0cyI7czoxOiI1IjtzOjMwOiJ0aGVjb3Jwb3JhdGlvbl9zZWFyY2hudW1fcG9zdHMiO3M6MToiNSI7czoyNzoidGhlY29ycG9yYXRpb25fdGFnbnVtX3Bvc3RzIjtzOjE6IjUiO3M6MjY6InRoZWNvcnBvcmF0aW9uX2RhdGVfZm9ybWF0IjtzOjY6Ik0gaiwgWSI7czoyNjoidGhlY29ycG9yYXRpb25fdXNlX2V4Y2VycHQiO047czoyNjoidGhlY29ycG9yYXRpb25faG9tZV9wYWdlXzEiO3M6OToiV2hhdCBJIERvIjtzOjIzOiJ0aGVjb3Jwb3JhdGlvbl9ibG9nX2NhdCI7czo0OiJCbG9nIjtzOjIzOiJ0aGVjb3Jwb3JhdGlvbl9zZXJ2aWNlcyI7czoyOiJvbiI7czozMToidGhlY29ycG9yYXRpb25faG9tZXBhZ2Vfd2lkZ2V0cyI7TjtzOjI0OiJ0aGVjb3Jwb3JhdGlvbl9zZXJ2aWNlXzEiO3M6ODoiV2hvIEkgQW0iO3M6MjQ6InRoZWNvcnBvcmF0aW9uX3NlcnZpY2VfMiI7czo5OiJXaGF0IEkgRG8iO3M6MjQ6InRoZWNvcnBvcmF0aW9uX3NlcnZpY2VfMyI7czo4OiJXaG8gSSBBbSI7czozMjoidGhlY29ycG9yYXRpb25fcG9zdGluZm9fZnJvbWJsb2ciO2E6Mjp7aTowO3M6NjoiYXV0aG9yIjtpOjE7czo0OiJkYXRlIjt9czozMDoidGhlY29ycG9yYXRpb25fZnJvbWJsb2dfcmVjZW50IjtzOjE6IjMiO3M6Mjk6InRoZWNvcnBvcmF0aW9uX2hvbWVwYWdlX3Bvc3RzIjtzOjE6IjciO3M6Mjk6InRoZWNvcnBvcmF0aW9uX2V4bGNhdHNfcmVjZW50IjtOO3M6MjM6InRoZWNvcnBvcmF0aW9uX2ZlYXR1cmVkIjtzOjI6Im9uIjtzOjI0OiJ0aGVjb3Jwb3JhdGlvbl9kdXBsaWNhdGUiO3M6Mjoib24iO3M6MjM6InRoZWNvcnBvcmF0aW9uX2ZlYXRfY2F0IjtzOjg6IkZlYXR1cmVkIjtzOjI3OiJ0aGVjb3Jwb3JhdGlvbl9mZWF0dXJlZF9udW0iO3M6MToiMyI7czoyNDoidGhlY29ycG9yYXRpb25fdXNlX3BhZ2VzIjtOO3M6MjU6InRoZWNvcnBvcmF0aW9uX2ZlYXRfcGFnZXMiO047czoyODoidGhlY29ycG9yYXRpb25fc2xpZGVyX2VmZmVjdCI7czo0OiJmYWRlIjtzOjI2OiJ0aGVjb3Jwb3JhdGlvbl9zbGlkZXJfYXV0byI7TjtzOjI2OiJ0aGVjb3Jwb3JhdGlvbl9wYXVzZV9ob3ZlciI7TjtzOjMxOiJ0aGVjb3Jwb3JhdGlvbl9zbGlkZXJfYXV0b3NwZWVkIjtzOjQ6IjMwMDAiO3M6MjQ6InRoZWNvcnBvcmF0aW9uX21lbnVwYWdlcyI7YToyOntpOjA7czozOiIyMzUiO2k6MTtzOjM6IjY2OCI7fXM6MzE6InRoZWNvcnBvcmF0aW9uX2VuYWJsZV9kcm9wZG93bnMiO3M6Mjoib24iO3M6MjQ6InRoZWNvcnBvcmF0aW9uX2hvbWVfbGluayI7czoyOiJvbiI7czoyNToidGhlY29ycG9yYXRpb25fc29ydF9wYWdlcyI7czoxMDoicG9zdF90aXRsZSI7czoyNToidGhlY29ycG9yYXRpb25fb3JkZXJfcGFnZSI7czozOiJhc2MiO3M6MzI6InRoZWNvcnBvcmF0aW9uX3RpZXJzX3Nob3duX3BhZ2VzIjtzOjE6IjMiO3M6MjM6InRoZWNvcnBvcmF0aW9uX21lbnVjYXRzIjthOjI6e2k6MDtzOjE6IjQiO2k6MTtzOjE6IjUiO31zOjQyOiJ0aGVjb3Jwb3JhdGlvbl9lbmFibGVfZHJvcGRvd25zX2NhdGVnb3JpZXMiO3M6Mjoib24iO3M6MzE6InRoZWNvcnBvcmF0aW9uX2NhdGVnb3JpZXNfZW1wdHkiO3M6Mjoib24iO3M6Mzc6InRoZWNvcnBvcmF0aW9uX3RpZXJzX3Nob3duX2NhdGVnb3JpZXMiO3M6MToiMyI7czoyMzoidGhlY29ycG9yYXRpb25fc29ydF9jYXQiO3M6NDoibmFtZSI7czoyNDoidGhlY29ycG9yYXRpb25fb3JkZXJfY2F0IjtzOjM6ImFzYyI7czozMDoidGhlY29ycG9yYXRpb25fZGlzYWJsZV90b3B0aWVyIjtOO3M6MjQ6InRoZWNvcnBvcmF0aW9uX3Bvc3RpbmZvMiI7YTo0OntpOjA7czo2OiJhdXRob3IiO2k6MTtzOjQ6ImRhdGUiO2k6MjtzOjEwOiJjYXRlZ29yaWVzIjtpOjM7czo4OiJjb21tZW50cyI7fXM6MjU6InRoZWNvcnBvcmF0aW9uX3RodW1ibmFpbHMiO3M6Mjoib24iO3M6MzI6InRoZWNvcnBvcmF0aW9uX3Nob3dfcG9zdGNvbW1lbnRzIjtzOjI6Im9uIjtzOjM2OiJ0aGVjb3Jwb3JhdGlvbl90aHVtYm5haWxfd2lkdGhfcG9zdHMiO3M6MzoiMTg1IjtzOjM3OiJ0aGVjb3Jwb3JhdGlvbl90aHVtYm5haWxfaGVpZ2h0X3Bvc3RzIjtzOjM6IjE4NSI7czozMDoidGhlY29ycG9yYXRpb25fcGFnZV90aHVtYm5haWxzIjtOO3M6MzM6InRoZWNvcnBvcmF0aW9uX3Nob3dfcGFnZXNjb21tZW50cyI7TjtzOjM2OiJ0aGVjb3Jwb3JhdGlvbl90aHVtYm5haWxfd2lkdGhfcGFnZXMiO3M6MzoiMTg1IjtzOjM3OiJ0aGVjb3Jwb3JhdGlvbl90aHVtYm5haWxfaGVpZ2h0X3BhZ2VzIjtzOjM6IjE4NSI7czoyNDoidGhlY29ycG9yYXRpb25fcG9zdGluZm8xIjthOjQ6e2k6MDtzOjY6ImF1dGhvciI7aToxO3M6NDoiZGF0ZSI7aToyO3M6MTA6ImNhdGVnb3JpZXMiO2k6MztzOjg6ImNvbW1lbnRzIjt9czozMToidGhlY29ycG9yYXRpb25fdGh1bWJuYWlsc19pbmRleCI7czoyOiJvbiI7czozNjoidGhlY29ycG9yYXRpb25fdGh1bWJuYWlsX3dpZHRoX3VzdWFsIjtzOjM6IjE2NCI7czozNzoidGhlY29ycG9yYXRpb25fdGh1bWJuYWlsX2hlaWdodF91c3VhbCI7czozOiIxNjQiO3M6Mjg6InRoZWNvcnBvcmF0aW9uX2N1c3RvbV9jb2xvcnMiO047czoyNDoidGhlY29ycG9yYXRpb25fY2hpbGRfY3NzIjtOO3M6Mjc6InRoZWNvcnBvcmF0aW9uX2NoaWxkX2Nzc3VybCI7czowOiIiO3M6Mjk6InRoZWNvcnBvcmF0aW9uX2NvbG9yX21haW5mb250IjtzOjA6IiI7czoyOToidGhlY29ycG9yYXRpb25fY29sb3JfbWFpbmxpbmsiO3M6MDoiIjtzOjI5OiJ0aGVjb3Jwb3JhdGlvbl9jb2xvcl9wYWdlbGluayI7czowOiIiO3M6MzY6InRoZWNvcnBvcmF0aW9uX2NvbG9yX3BhZ2VsaW5rX2FjdGl2ZSI7czowOiIiO3M6Mjk6InRoZWNvcnBvcmF0aW9uX2NvbG9yX2hlYWRpbmdzIjtzOjA6IiI7czozNDoidGhlY29ycG9yYXRpb25fY29sb3Jfc2lkZWJhcl9saW5rcyI7czowOiIiO3M6MzA6InRoZWNvcnBvcmF0aW9uX2Zvb3Rlcl9oZWFkaW5ncyI7czowOiIiO3M6MzI6InRoZWNvcnBvcmF0aW9uX2NvbG9yX2Zvb3RlcmxpbmtzIjtzOjA6IiI7czoyOToidGhlY29ycG9yYXRpb25fc2VvX2hvbWVfdGl0bGUiO047czozNToidGhlY29ycG9yYXRpb25fc2VvX2hvbWVfZGVzY3JpcHRpb24iO047czozMjoidGhlY29ycG9yYXRpb25fc2VvX2hvbWVfa2V5d29yZHMiO047czozMzoidGhlY29ycG9yYXRpb25fc2VvX2hvbWVfY2Fub25pY2FsIjtOO3M6MzM6InRoZWNvcnBvcmF0aW9uX3Nlb19ob21lX3RpdGxldGV4dCI7czowOiIiO3M6Mzk6InRoZWNvcnBvcmF0aW9uX3Nlb19ob21lX2Rlc2NyaXB0aW9udGV4dCI7czowOiIiO3M6MzY6InRoZWNvcnBvcmF0aW9uX3Nlb19ob21lX2tleXdvcmRzdGV4dCI7czowOiIiO3M6Mjg6InRoZWNvcnBvcmF0aW9uX3Nlb19ob21lX3R5cGUiO3M6Mjc6IkJsb2dOYW1lIHwgQmxvZyBkZXNjcmlwdGlvbiI7czozMjoidGhlY29ycG9yYXRpb25fc2VvX2hvbWVfc2VwYXJhdGUiO3M6MzoiIHwgIjtzOjMxOiJ0aGVjb3Jwb3JhdGlvbl9zZW9fc2luZ2xlX3RpdGxlIjtOO3M6Mzc6InRoZWNvcnBvcmF0aW9uX3Nlb19zaW5nbGVfZGVzY3JpcHRpb24iO047czozNDoidGhlY29ycG9yYXRpb25fc2VvX3NpbmdsZV9rZXl3b3JkcyI7TjtzOjM1OiJ0aGVjb3Jwb3JhdGlvbl9zZW9fc2luZ2xlX2Nhbm9uaWNhbCI7TjtzOjM3OiJ0aGVjb3Jwb3JhdGlvbl9zZW9fc2luZ2xlX2ZpZWxkX3RpdGxlIjtzOjk6InNlb190aXRsZSI7czo0MzoidGhlY29ycG9yYXRpb25fc2VvX3NpbmdsZV9maWVsZF9kZXNjcmlwdGlvbiI7czoxNToic2VvX2Rlc2NyaXB0aW9uIjtzOjQwOiJ0aGVjb3Jwb3JhdGlvbl9zZW9fc2luZ2xlX2ZpZWxkX2tleXdvcmRzIjtzOjEyOiJzZW9fa2V5d29yZHMiO3M6MzA6InRoZWNvcnBvcmF0aW9uX3Nlb19zaW5nbGVfdHlwZSI7czoyMToiUG9zdCB0aXRsZSB8IEJsb2dOYW1lIjtzOjM0OiJ0aGVjb3Jwb3JhdGlvbl9zZW9fc2luZ2xlX3NlcGFyYXRlIjtzOjM6IiB8ICI7czozNDoidGhlY29ycG9yYXRpb25fc2VvX2luZGV4X2Nhbm9uaWNhbCI7TjtzOjM2OiJ0aGVjb3Jwb3JhdGlvbl9zZW9faW5kZXhfZGVzY3JpcHRpb24iO047czoyOToidGhlY29ycG9yYXRpb25fc2VvX2luZGV4X3R5cGUiO3M6MjQ6IkNhdGVnb3J5IG5hbWUgfCBCbG9nTmFtZSI7czozMzoidGhlY29ycG9yYXRpb25fc2VvX2luZGV4X3NlcGFyYXRlIjtzOjM6IiB8ICI7czozODoidGhlY29ycG9yYXRpb25faW50ZWdyYXRlX2hlYWRlcl9lbmFibGUiO3M6Mjoib24iO3M6MzY6InRoZWNvcnBvcmF0aW9uX2ludGVncmF0ZV9ib2R5X2VuYWJsZSI7czoyOiJvbiI7czo0MToidGhlY29ycG9yYXRpb25faW50ZWdyYXRlX3NpbmdsZXRvcF9lbmFibGUiO3M6Mjoib24iO3M6NDQ6InRoZWNvcnBvcmF0aW9uX2ludGVncmF0ZV9zaW5nbGVib3R0b21fZW5hYmxlIjtzOjI6Im9uIjtzOjMxOiJ0aGVjb3Jwb3JhdGlvbl9pbnRlZ3JhdGlvbl9oZWFkIjtzOjA6IiI7czozMToidGhlY29ycG9yYXRpb25faW50ZWdyYXRpb25fYm9keSI7czowOiIiO3M6Mzc6InRoZWNvcnBvcmF0aW9uX2ludGVncmF0aW9uX3NpbmdsZV90b3AiO3M6MDoiIjtzOjQwOiJ0aGVjb3Jwb3JhdGlvbl9pbnRlZ3JhdGlvbl9zaW5nbGVfYm90dG9tIjtzOjA6IiI7czoyNToidGhlY29ycG9yYXRpb25fNDY4X2VuYWJsZSI7TjtzOjI0OiJ0aGVjb3Jwb3JhdGlvbl80NjhfaW1hZ2UiO3M6MDoiIjtzOjIyOiJ0aGVjb3Jwb3JhdGlvbl80NjhfdXJsIjtzOjA6IiI7czoyNjoidGhlY29ycG9yYXRpb25fNDY4X2Fkc2Vuc2UiO3M6MDoiIjt9';

	/*global $options;

	foreach ($options as $value) {
		if( isset( $value['id'] ) ) {
			update_option( $value['id'], $value['std'] );
		}
	}*/

	$importedOptions = unserialize(base64_decode($importOptions));

	foreach ($importedOptions as $key=>$value) {
		if ($value != '') update_option( $key, $value );
	}
	update_option( $shortname . '_use_pages', 'false' );
} ?>